# White blood cell filtration for RNA-sequencing

# Requirements

## Software

A `conda`/`mamba` environment `yml` file is available for all read processing scripts (i.e., all analyses located in ``). To re-create it on your machine in a conda environment named `wbc_depletion`, you can run:

```
conda env create -f environment.yml
```

The Nextflow pipeline ([nf-core/rnaseq v3.14.0](https://nf-co.re/rnaseq/3.14.0/)) was run using Nextflow version 24.04.4 that was manually installed (`curl -s https://get.nextflow.io | bash `), but it could also be added to the conda environment instead (`conda install -c bioconda -n wbc_depletion nextflow`).

For the downstream expression analyses in R, an `renv` environment was created. You can re-use it in R by opening the R project in the root directory and then running `renv::restore()`. For more info, check the [renv documentation](https://rstudio.github.io/renv/articles/renv.html).

# Input data

The raw fastq files should be placed inside the `./data/fastq` folder. They are available from ...

Reference files can be downloaded by running (`./scripts/0_download_refs.sh`).

The `nf-core/rnaseq` pipeline requires a `samplesheet.csv` file containing absolute file paths to each of these files. It can be generated by running `python fastq_dir_to_samplesheet.py $(realpath ./fastq) samplesheet.csv` from the `./data` directory.

## A note about file paths

The majority of scripts used in this project are configured to automatically use relative paths from the project/repo root directory. However, there are a few exceptions that need to be manually set prior to running the scripts:

- `./data/samplesheet.csv` already mentioned above requires absolute file paths.
- `config/fastq-screen.conf` requires absolute paths to the reference genome databases (line 80-81).

Additionally, if scripts are moved around, the automatic resolving of the paths (based on the script's location relative to the project root) will fail. In case path resolution still fails, simply replace the `SCRIPT_DIR` and `PROJECT_ROOT` variables with an absolute path to the script/repository root directories on your machine.

# Running the analyses

All analyses scripts are numbered in the order in which they should be run. For some steps there are both shell (bash) and slurm scripts; in this case the slurm script is just a wrapper for the associated shell script. For steps that only consist of slurm scripts, these can simply be run as if they were regular shell scripts.

# Output report

An Rmarkdown report is available as a rendered HTML file in `./results/1_expression_analysis.html`.
